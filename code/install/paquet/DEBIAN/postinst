#!/bin/bash

###########################
# Parameters / Paramètres #
###########################

# Guess and set the home path
# Deviner et définir le chemin vers le home
if [ -n "$SUDO_USER" ];
    then
	USER_HOME=/home/$SUDO_USER
elif [ -d "/home/tech" ]
    then
	USER_HOME=/home/tech
else
	USER_HOME=$HOME
fi

PAQUETNAME=snack
DATABASE=radius
SSL_CONF=/etc/ssl/openssl.cnf
RADIUS_PATH=/etc/freeradius
APACHE_PATH=/etc/apache2
NULL=/dev/null

DEST_ROOT_PATH=$USER_HOME/$PAQUETNAME
DEST_PATH=$DEST_ROOT_PATH/cert

RADCERT_VALIDITY=3650 #ten years
CA_CERT_VALIDITY=3650 #ten years

ROOT_MODE=0070
ONLY_RADIUS_ACCESS=0700
INTERFACE_ACCESS=0770 
INTERFACE_THROUGH=0710
READ_ONLY=0440
ONLY_INTERFACE_ACCESS=0700

INTERFACE_USER=www-data
RADIUS_USER=freerad

CA_KEY=cakey.pem
CA_REQ=careq.pem
CA_CERT=cacert.pem

RADIUS_KEY=radius_key.pem
RADIUS_REQ=radius_req.pem
RADIUS_CERT=radius_cert.pem

EAP_CONF=${RADIUS_PATH}/eap.conf
SQL_CONF=${RADIUS_PATH}/sql.conf
RADIUSD_CONF=${RADIUS_PATH}/radiusd.conf

APACHE_PORTS_CONF=${APACHE_PATH}/ports.conf
APACHE_SNACK=${APACHE_PATH}/sites-available/snack

STEP=1
GAUGE=0

whiptail --title SNACK --infobox "\nWelcome !\n\nYou are installing SNACK." 10 70 10 70
sleep 1

##############################################################
# Radius-Mysql configuration / Configuration de Radius-Mysql #
##############################################################

echo 0 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring Mysql for Radius...Create database." 10 70 0
sleep 0.5

# Create database + Add default admin user account
# Création de la base de donnée + Ajout d'un compte administrateur par défaut

PASSWORD_DB_ROOT=$(whiptail --title SNACK --inputbox "\n\nWhat is the Mysql password for root?" 10 70 3>&1 1>&2 2>&3)
 
if [ $? != 0 ]; then
	whiptail --title SNACK --msgbox "\n\nUser has canceled the installation!" 10 70
	exit 1
fi

while [ -z "${PASSWORD_RADIUS}" -o ${PASSWORD_RADIUS} != ${PASSWORD_RADIUS_BIS} ] 
do
    if [ -n "${PASSWORD_RADIUS}" ]
    then
	whiptail --title SNACK --infobox "\n\nError: Password not corresponding!" 10 70
	sleep 1
    fi

    PASSWORD_RADIUS=$(whiptail --title SNACK --inputbox "\n\nDefine the password for administrator:" 10 70 3>&1 1>&2 2>&3)
     
    if [ $? != 0 ]; then
	whiptail --title SNACK --msgbox "\n\nUser has canceled the installation!" 10 70
    	exit 1
    fi
    
    PASSWORD_RADIUS_BIS=$(whiptail --title SNACK --inputbox "\n\nRe-enter the password for administrator:" 10 70 3>&1 1>&2 2>&3)
     
    if [ $? != 0 ]; then
	whiptail --title SNACK --msgbox "\n\nUser has canceled the installation!" 10 70
    	exit 1
    fi
done

echo "	CREATE DATABASE ${DATABASE} DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;\
	GRANT ALL ON ${DATABASE}.* to radius@localhost identified by '${PASSWORD_RADIUS}';\
	GRANT ALL ON ${DATABASE}.logs to logsfreeradius@localhost identified by 'logsfreeradius';\
	flush privileges;\
" | mysql -uroot -p${PASSWORD_DB_ROOT} > $NULL 2>>errors.log

until [ $? -eq 0 ]
do
	PASSWORD_DB_ROOT=$(whiptail --title SNACK --inputbox "\n\nError: Cannot create database!\nWhat is the Mysql password for root?" 10 70 3>&1 1>&2 2>&3)
 
	if [ $? != 0 ]; then
		whiptail --title SNACK --msgbox "\n\nUser has canceled the installation!" 10 70
		exit 1
	fi

	echo "	CREATE DATABASE ${DATABASE} DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;\
		GRANT ALL ON ${DATABASE}.* to radius@localhost identified by '${PASSWORD_RADIUS}';\
		GRANT ALL ON ${DATABASE}.logs to logsfreeradius@localhost identified by 'logsfreeradius';\
		flush privileges;\
	" | mysql -uroot -p${PASSWORD_DB_ROOT} > $NULL 2>>errors.log
done

echo 20 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring Mysql for Radius...\nCreate tables." 10 70 0

mysql -uroot -p${PASSWORD_DB_ROOT} ${DATABASE} < /etc/freeradius/sql/mysql/schema.sql > $NULL 2>>errors.log
mysql -uroot -p${PASSWORD_DB_ROOT} ${DATABASE} < /etc/freeradius/sql/mysql/nas.sql > $NULL 2>>errors.log
mysql -uroot -p${PASSWORD_DB_ROOT} ${DATABASE} < /tmp/snack/schema.sql > $NULL 2>>errors.log

echo "INSERT INTO radcheck(UserName, Attribute, op, Value) VALUES ('admin', 'Cleartext-Password', ':=', '${PASSWORD_RADIUS}');" | mysql -uroot -p${PASSWORD_DB_ROOT} ${DATABASE}

echo 50 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring Mysql for Radius...\nConfigure Freeradius." 10 70 0

# Configuration de Radius pour intéragir avec la base de donnée
# Radius configuration in order to interact with our database

sed\
	-e "s/radpass/${PASSWORD_RADIUS}/"\
	-e "s/#\(readclients\)/\1/"\
	-i $SQL_CONF

echo 75 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring Mysql for Radius...\nConfigure Freeradius." 10 70 0

#TODO: change virtual server (bh.consulting.net => snack)
sed\
	-e 's/#\(\s*\$INCLUDE sql\.conf\)/\1/'\
	-e 's/#\(\s*\$INCLUDE sql\/mysql\/counter.conf\)/\1/'\
	-e 'N; s/\(#\s*clients\s*=\s*per_socket_clients.*\)\(}\)/\1\tvirtual_server = bh.consulting.net\n\2/'\
	-e 's/\(\$INCLUDE clients\.conf\)/#\1/'\
	-i $RADIUSD_CONF

echo 100 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring Mysql for Radius...\nDone!" 10 70 0
sleep 0.2

STEP=2

##############################
# Certificates / Certificats #
##############################

echo 0 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius..." 10 70 0
sleep 0.5

CLIENTNAME=$(whiptail --title SNACK --inputbox "\n\nEnter the name of the client (CA common name):" 10 70 3>&1 1>&2 2>&3)
     
if [ $? != 0 ]; then
	whiptail --title SNACK --msgbox "\n\nUser has canceled the installation!" 10 70
	exit 1
fi

echo 5 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nConfiguring SSL." 10 70 0

# Update openssl.cnf configuration
# Mise à jour de la configuration openssl.cnf

sed\
	-e "s|./demoCA|$DEST_PATH |"\
	-e "/\s*certificate\s*=/c certificate = \$dir/private/cacert.pem\t"\
	-i $SSL_CONF
echo "" >> $SSL_CONF

echo "[xpclient_ext]" >> $SSL_CONF
echo "extendedKeyUsage=1.3.6.1.5.5.7.3.2" >> $SSL_CONF
echo "" >> $SSL_CONF
echo "[xpserver_ext]" >> $SSL_CONF
echo "extendedKeyUsage=1.3.6.1.5.5.7.3.1" >> $SSL_CONF

echo 10 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nCreate directories." 10 70 0

# Creation of the needed repertories
# Création des répertoires nécessaires

if test ! -d $DEST_ROOT_PATH
then
	mkdir -p $DEST_ROOT_PATH -m $ROOT_MODE
fi

mkdir $DEST_PATH -m $INTERFACE_ACCESS;
mkdir "${DEST_PATH}/certs" -m $INTERFACE_THROUGH;
mkdir "${DEST_PATH}/crl" -m $INTERFACE_ACCESS ;
mkdir "${DEST_PATH}/newcerts" -m $INTERFACE_ACCESS;
mkdir "${DEST_PATH}/private" -m $INTERFACE_THROUGH;
mkdir "${DEST_PATH}/users" -m $INTERFACE_ACCESS;
touch $DEST_PATH/index.txt
echo "01" > $DEST_PATH/crlnumber

echo 20 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nGenerate certificate authority" 10 70 0

# Creation of the Authority Certificate (CA)
# Création du certificat d'autorité (CA)

{
openssl genrsa -out $DEST_PATH/private/$CA_KEY 4096

openssl req \
	-new \
	-key $DEST_PATH/private/$CA_KEY \
	-subj /countryName=FR/stateOrProvinceName=France/localityName=Nancy/organizationName="B.H. Consulting"/commonName="$CLIENTNAME"/ \
	-out $DEST_PATH/private/$CA_REQ

openssl ca \
	-config /etc/ssl/openssl.cnf \
	-create_serial \
	-out $DEST_PATH/private/$CA_CERT \
	-days $CA_CERT_VALIDITY \
	-batch \
	-keyfile $DEST_PATH/private/$CA_KEY \
	-selfsign \
	-extensions v3_ca \
	-infiles $DEST_PATH/private/$CA_REQ
} > $NULL 2>>errors.log

echo 30 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nSet permissions." 10 70 0

# Setting approriates permissions
# Affectation des permissions

chown $INTERFACE_USER $DEST_PATH/private/$CA_KEY
chmod $INTERFACE_ACCESS $DEST_PATH/private/$CA_KEY
chmod $READ_ONLY $DEST_PATH/private/$CA_CERT

echo 35 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nGenerate Freeradius certicate" 10 70 0

# Creation of the radius certificate
# Création du certificat authentifiant le server radius

{
openssl genrsa -out $DEST_PATH/private/$RADIUS_KEY 4096

openssl req \
	-config /etc/ssl/openssl.cnf -new -key $DEST_PATH/private/$RADIUS_KEY \
	-subj /countryName=FR/stateOrProvinceName=France/localityName=Nancy/organizationName="B.H. Consulting"/commonName=`hostname`/ \
	-out $DEST_PATH/private/$RADIUS_REQ \
	-days $RADCERT_VALIDITY

openssl ca \
	-config /etc/ssl/openssl.cnf \
	-policy policy_anything \
	-out $DEST_PATH/private/$RADIUS_CERT \
	-batch \
	-extensions xpserver_ext \
	-infiles $DEST_PATH/private/$RADIUS_REQ \
} > $NULL 2>>errors.log

echo 40 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nSet permissions." 10 70 0

# Setting approriates permissions
# Affectation des permissions

chown $RADIUS_USER $DEST_PATH/private/$RADIUS_KEY
chown $RADIUS_USER $DEST_PATH/private/$RADIUS_CERT
chmod $ONLY_RADIUS_ACCESS $DEST_PATH/private/$RADIUS_KEY
chmod $ONLY_RADIUS_ACCESS $DEST_PATH/private/$RADIUS_CERT

echo 45 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nCreate certificate revocation list." 10 70 0

# First CRL Generation + link to permit revocation verifications
# Première génération de la CRL + permission de révocation

openssl ca \
	-config /etc/ssl/openssl.cnf \
	-gencrl \
	-out $DEST_PATH/crl/crl.pem \
> $NULL 2>>errors.log

HASH=`openssl x509 -noout -hash -in $DEST_PATH/private/$CA_CERT`
ln -s $DEST_PATH/private/$CA_CERT $DEST_PATH/certs/$HASH.0
ln -s $DEST_PATH/crl/crl.pem $DEST_PATH/certs/$HASH.r0

# Setting approriates permissions
# Affectation des permissions

chown $RADIUS_USER $DEST_PATH/crl/crl.pem
chmod $INTERFACE_ACCESS $DEST_PATH/crl/crl.pem

echo 60 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nConfigure random module." 10 70 0

# Now, we configure the radius to use certificates
# Maintenant, on configure le radius pour qu'il utilise les certificats

# First, we must create those two file
# On doit d'abord créer ces deux fichiers

dd if=/dev/urandom of=$DEST_PATH/random count=2
openssl dhparam -check -text -5 1024 -out $DEST_PATH/dh

# Setting approriates permissions
# Affectation des permissions

chown $RADIUS_USER $DEST_PATH/random
chown $RADIUS_USER $DEST_PATH/dh
chmod $ONLY_RADIUS_ACCESS $DEST_PATH/random
chmod $ONLY_RADIUS_ACCESS $DEST_PATH/dh

echo 70 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nConfigure Freeradius TLS authentication." 10 70 0

# Setting the eap.conf file
# onfiguration du fichier eap.conf

# TLS
sed\
        -e "/certdir =/i \\\t\t\tconfdir = $DEST_PATH"\
        -e "/certdir =/c \\\t\t\tcertdir = \${confdir}"\
        -e "/cadir =/c \\\t\t\tcadir = \${confdir}/private"\
        -e "/private_key_password =/c \\\t\t\tprivate_key_password ="\
        -e "/private_key_file =/c \\\t\t\tprivate_key_file = \${cadir}/$RADIUS_KEY"\
        -e "/^\s*certificate_file =/c \\\t\t\tcertificate_file = \${cadir}/$RADIUS_CERT"\
        -e "/^\s*CA_file =/c \\\t\t\tCA_file = \${cadir}/$CA_CERT"\
        -e "/dh_file =/c \\\t\t\tdh_file = \${certdir}/dh"\
        -e "/check_crl =/c \\\t\t\tcheck_crl = yes"\
        -e "/^\s*#*CA_path =/c \\\t\t\tCA_path = \${certdir}/certs"\
        -e "/^\s*#*\s*check_cert_cn =/c \\\t\t\tcheck_cert_cn = %{User-Name}"\
        -i $EAP_CONF

echo 80 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nImport scripts for the web interface." 10 70 0

# Copy scripts version
# Copie des scripts

mv /tmp/snack/scripts $USER_HOME/$PAQUETNAME

# Setting approriates permissions
# Affecter les permissions

chown -R $INTERFACE_USER $USER_HOME/$PAQUETNAME/scripts
chmod -R $ONLY_INTERFACE_ACCESS $USER_HOME/$PAQUETNAME/scripts

echo 90 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nCreate snack group." 10 70 0

# Setting access groups to include web interface and radius
# Nouveau groupe regroupant l'interface et le radius

groupadd snack
usermod -a -G snack $RADIUS_USER
usermod -a -G snack $INTERFACE_USER
chown -R :snack $USER_HOME/$PAQUETNAME

echo 100 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring certificates for Radius...\nDone!" 10 70 0
sleep 0.2

STEP=3

##########
# Apache #
##########

echo 0 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring apache for Radius...\nVirtual servers management." 10 70 0
sleep 0.5

# Apache configuration
# Configuraton du serveur Apache

sed \
	-e "s|INTERFACE_PATH|${DEST_ROOT_PATH}/interface|"\
	-i $APACHE_SNACK

rm -f ${APACHE_PATH}/sites-enabled/000-default

echo 33 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring apache for Radius...\nEnabling ssl and rewrite modules." 10 70 0

{
a2enmod ssl
a2enmod rewrite
} > $NULL 2>>errors.log

echo 66 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring apache for Radius...\nMysql access for radius." 10 70 0

sed \
	-e "s/\('password' =>\) '.*'/\1 '${PASSWORD_RADIUS}'/"\
	-i ${DEST_ROOT_PATH}/interface/app/Config/database.php

echo 100 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring apache for Radius...\nDone!" 10 70 0
sleep 0.2

##########
# Syslog #
##########

echo 0 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring syslog for Radius..." 10 70 0
sleep 0.5

# Activate syslog for freeradius
# Active Syslog pour Freeradius

sed\
	-e 's/\(destination\s*=\s*\).*$/\1syslog/'\
	-e 's/\(syslog_facility\s*=\s*\).*$/\1local2/'\
	-i $RADIUSD_CONF

echo 100 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Configuring syslog for Radius...\nDone!" 10 70 0
sleep 0.2
sleep 0.5

STEP=4

echo 0 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Restarting services...\nSyslog-ng" 10 70 0
service syslog-ng restart > $NULL 2>>errors.log

echo 33 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Restarting services...\nFreeradius" 10 70 0
service freeradius restart > $NULL 2>>errors.log

echo 66 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Restarting services...\nApache2" 10 70 0
service apache2 restart > $NULL 2>>errors.log

echo 100 | whiptail --title SNACK --gauge "\n\nStep #${STEP}: Restarting services...\nDone!" 10 70 0
sleep 0.2

STEP=5

# Delete temporary directory
# Suppression du dossier temporaire

whiptail --title SNACK --infobox "\n\nStep #${STEP}: Cleaning..." 10 70 10 70
sleep 0.5

rm -r /tmp/snack

whiptail --title SNACK --msgbox "\n\nInstallation done!" 10 70

exit 0

